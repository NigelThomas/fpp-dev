-- typed_ingest_pump.sql
-- 
-- This assumes that in interface.transactions each column is individually typed the same as the source

CREATE OR REPLACE PUMP "interface"."ingest_pump" STOPPED 
AS 
INSERT INTO "interface"."transactions"
( ROWTIME
, "txnId"
, "userId"
, "deviceId"
, "city_cf"
, "country_cf"
, "state_cf"
, "context_client"
, "context_events"
, "context_flag001"
, "context_flag002"
, "context_usergroups"
, "day_of_week"
, "gemaltoRiskEngine_attributes_deviceBrowser_browserName"
, "gemaltoRiskEngine_attributes_deviceBrowser_browserVersion"
, "gemaltoRiskEngine_attributes_deviceBrowser_isRooted"
, "gemaltoRiskEngine_attributes_deviceBrowser_networkIp"
, "gemaltoRiskEngine_attributes_deviceBrowser_osFamily"
, "gemaltoRiskEngine_attributes_deviceBrowser_osName"
, "gemaltoRiskEngine_attributes_deviceBrowser_osReleaseDateOrder"
, "gemaltoRiskEngine_attributes_deviceBrowser_osVersionOfFamily"
, "gemaltoRiskEngine_attributes_deviceBrowser_osVersion"
, "gemaltoRiskEngine_attributes_deviceBrowser_screenHeight"
, "gemaltoRiskEngine_attributes_deviceBrowser_screenWidth"
, "gemaltoRiskEngine_attributes_deviceBrowser_userAgent"
, "gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_fingerprint"
, "gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_manufacturer"
, "gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_model"
, "gemaltoRiskEngine_attributes_deviceMobileApp_location_signals_source"
, "gemaltoRiskEngine_attributes_deviceMobileApp_network_signals_hwAddress"
, "gemaltoRiskEngine_attributes_deviceMobileApp_network_signals_type"
, "gemaltoRiskEngine_attributes_deviceMobileApp_platformSettings_signals_isBluetoothEnabled"
, "gemaltoRiskEngine_attributes_deviceMobileApp_platformSettings_signals_isLocationEnabled"
, "gemaltoRiskEngine_attributes_deviceMobileApp_platformSettings_signals_isWifiEnabled"
, "gemaltoRiskEngine_attributes_deviceMobileApp_platform_signals_family"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_area_code"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_city"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_postal_code"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_time_zone"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CountryData_country_code"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CountryData_country"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_StateData_state_code"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_StateData_state"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_continent"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_dma"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_latitude"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_longitude"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_msa"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_region"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_Domain_sld"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_Domain_tld"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_asn"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_carrier"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_connection_type"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_hosting_facility"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_ip_routing_type"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_line_speed"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_organization"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_ProxyData_proxy_level"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_ProxyData_proxy_type"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_anonymizer_status"
, "gemaltoRiskEngine_attributes_ipintelligence_ipinfo_ip_type"
, "hour_of_day"
, "visitId"
)
SELECT STREAM
  "txn_time" AS ROWTIME      -- promote to ROWTIME
, "$oid"        -- identifies the transaction
, "userId"               -- used for windows
, "f19_gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_fingerprint"             -- used for windows = deviceId
, "city_cf"               -- locations come with confidence
, "country_cf"
, "state_cf"
, "f01_context_client"    -- from here, the features, in alphabetical order of path
, "f02_context_events"
, "f03_context_flag001"
, "f04_context_flag002"
, "f05_context_usergroups"
, "f06_day_of_week"
, "f07_gemaltoRiskEngine_attributes_deviceBrowser_browserName"
, "f08_gemaltoRiskEngine_attributes_deviceBrowser_browserVersion"
, "f09_gemaltoRiskEngine_attributes_deviceBrowser_isRooted"
, "f10_gemaltoRiskEngine_attributes_deviceBrowser_networkIp"
, "f11_gemaltoRiskEngine_attributes_deviceBrowser_osFamily"
, "f12_gemaltoRiskEngine_attributes_deviceBrowser_osName"
, "f13_gemaltoRiskEngine_attributes_deviceBrowser_osReleaseDateOrder"
, "f14_gemaltoRiskEngine_attributes_deviceBrowser_osVersionOfFamily"
, "f15_gemaltoRiskEngine_attributes_deviceBrowser_osVersion"
, "f16_gemaltoRiskEngine_attributes_deviceBrowser_screenHeight"
, "f17_gemaltoRiskEngine_attributes_deviceBrowser_screenWidth"
, "f18_gemaltoRiskEngine_attributes_deviceBrowser_userAgent"
, "f19_gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_fingerprint"
, "f20_gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_manufacturer"
, "f21_gemaltoRiskEngine_attributes_deviceMobileApp_device_signals_model"
, "f22_gemaltoRiskEngine_attributes_deviceMobileApp_location_signals_source"
, "f23_gemaltoRiskEngine_attributes_deviceMobileApp_network_signals_hwAddress"
, "f24_gemaltoRiskEngine_attributes_deviceMobileApp_network_signals_type"
, "f25_gemaltoRiskEngine_attributes_deviceMobileApp_platformSettings_signals_isBluetoothEnabled"
, "f26_gemaltoRiskEngine_attributes_deviceMobileApp_platformSettings_signals_isLocationEnabled"
, "f27_gemaltoRiskEngine_attributes_deviceMobileApp_platformSettings_signals_isWifiEnabled"
, "f28_gemaltoRiskEngine_attributes_deviceMobileApp_platform_signals_family"
, "f29_gemaltoRiskEngine_attributes_ipintelf29ligence_ipinfo_Location_CityData_area_code"
, "f30_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_city"
, "f31_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_postal_code"
, "f32_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CityData_time_zone"
, "f33_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CountryData_country_code"
, "f34_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_CountryData_country"
, "f35_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_StateData_state_code"
, "f36_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_StateData_state"
, "f37_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_continent"
, "f38_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_dma"
, "f39_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_latitude"
, "f40_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_longitude"
, "f41_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_msa"
, "f42_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Location_region"
, "f43_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_Domain_sld"
, "f44_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_Domain_tld"
, "f45_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_asn"
, "f46_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_carrier"
, "f47_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_connection_type"
, "f48_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_hosting_facility"
, "f49_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_ip_routing_type"
, "f50_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_line_speed"
, "f51_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_Network_organization"
, "f52_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_ProxyData_proxy_level"
, "f53_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_ProxyData_proxy_type"
, "f54_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_anonymizer_status"
, "f55_gemaltoRiskEngine_attributes_ipintelligence_ipinfo_ip_type"
, "f56_hour_of_day"
, "f57_visitId"
FROM "sample_json_ingest"."sample_json_with_times" s
WHERE "rulesetExternalId" = 'pilot_1'            -- we only want one set of data for each txn
ORDER BY "txn_time" WITHIN INTERVAL '10' SECOND
;
